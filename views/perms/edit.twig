{% extends "layout.twig" %}
{% block title %}ุชุนุฏูู ุฅุนุฏุงุฏ:
	{{ row.key }}
{% endblock %}

{% block content %}
	<div class="d-flex justify-content-between align-items-center mb-3">
		<h1 class="h4">ุชุนุฏูู ุฅุนุฏุงุฏ</h1>
		<a href="{{ base }}?type={{ row.type }}" class="btn btn-light">ุฑุฌูุน</a>
	</div>

	{% if errs %}
		<div class="alert alert-danger">{{ errs|nl2br }}</div>
	{% endif %}

	<form method="post" action="{{ base }}/{{ row.key }}/update" enctype="multipart/form-data" class="card">

		<div class="card-body">
			{{ csrf_field()|raw }}

			<div class="row g-3">

				<div class="col-md-4">
					<label class="form-label">ุงููุฆุฉ</label>
					<input class="form-control" value="{{ row.type }}" disabled>
				</div>

				<div class="col-md-4">
					<label class="form-label">ุงูููุชุงุญ</label>
					<input class="form-control" value="{{ row.key }}" disabled>
				</div>

				<div class="col-md-4">
					<label class="form-label">ููุน ุงููููุฉ</label>
					<input class="form-control" value="{{ row.val_type }}" disabled>
				</div>

				<div class="col-md-4">
					<label class="form-label">ุงูุญุงูุฉ</label>
					<select name="status" class="form-select">
						<option value="active" {{ row.status=='active' ? 'selected' : '' }}>active</option>
						<option value="inactive" {{ row.status=='inactive' ? 'selected' : '' }}>inactive</option>
					</select>
				</div>

				<div class="col-12">
					<label class="form-label">ุงููุตู</label>
					<input type="text" name="desc" class="form-control" value="{{ row.desc ?? '' }}">
				</div>

				{# ============================== #
				               ุนุฑุถ ุฎุงูุฉ ุงููููุฉ ุญุณุจ val_type
				               ============================== #}

				{% if row.val_type == 'text' %}
					<div class="col-12">
						<label class="form-label">ุงููููุฉ</label>
						<input type="text" name="value_text" class="form-control" value="{{ row.value }}">
					</div>

				{% elseif row.val_type == 'textarea' %}
					<div class="col-12">
						<label class="form-label">ุงููููุฉ (ูุต ุทููู)</label>
						<textarea name="value_textarea" class="form-control" rows="4">{{ row.value }}</textarea>
					</div>

				{% elseif row.val_type == 'switch' %}
					<div class="col-12">
						<label class="form-label d-block">ุชุดุบูู / ุฅููุงู</label>
						<div class="form-check form-switch">
							<input type="checkbox" class="form-check-input" name="value_switch" id="switchInputEdit" value="1" {{ row.value == '1' ? 'checked' : '' }}>
							<label class="form-check-label" for="switchInputEdit">
								ุชูุนูู ุงูุฅุนุฏุงุฏ
							</label>
						</div>
						<div class="form-text">ุงููููุฉ ุงููุนููุฉ ุชูุฎุฒู 1 ุฃู 0.</div>
					</div>

				{% elseif row.val_type == 'select' %}
					<div class="col-12">
						<label class="form-label">ุฎูุงุฑุงุช ุงููุงุฆูุฉ</label>

						<table class="table table-bordered" id="opt_table_edit">
							<thead>
								<tr>
									<th style="width:40%">Value</th>
									<th style="width:40%">Label</th>
									<th style="width:20%"></th>
								</tr>
							</thead>
							<tbody>
								{% for op in options %}
									<tr>
										<td><input class="form-control v" value="{{ op.value }}" oninput="updateRawEdit()"></td>
										<td><input class="form-control l" value="{{ op.label }}" oninput="updateRawEdit()"></td>
										<td class="text-center">
											<button type="button" class="btn btn-sm btn-danger" onclick="this.closest('tr').remove(); updateRawEdit();">ร</button>
										</td>
									</tr>
								{% endfor %}
							</tbody>
						</table>

						<button type="button" class="btn btn-sm btn-secondary mb-2" onclick="addOptRowEdit()">+ ุฎูุงุฑ ุฌุฏูุฏ</button>

						<textarea name="options" id="options_json_edit" class="d-none"></textarea>

						<label class="form-label mt-2">ุงููููุฉ ุงููุฎุชุงุฑุฉ (value)</label>
						<input type="text" name="value_select" class="form-control text-start" style="direction:ltr" value="{{ row.value }}">
					</div>

				{% elseif row.val_type == 'image' %}
					<div class="col-12">
						<label class="form-label d-block">ุงูุตูุฑุฉ ุงูุญุงููุฉ</label>
						{% if row.value %}
							<img src="/uploads/{{ row.value }}" class="rounded border mb-2" style="width:150px;height:100px;object-fit:cover">
						{% else %}
							<div class="text-muted mb-2">ูุง ุชูุฌุฏ ุตูุฑุฉ ูุญููุธุฉ.</div>
						{% endif %}
						<input type="file" name="value_image" class="form-control">
						<div class="form-text">ุงุชุฑูู ูุงุฑุบุงู ููุฅุจูุงุก ุนูู ุงูุตูุฑุฉ ุงูุญุงููุฉ.</div>
					</div>
				{% endif %}

			</div>

			{# ============================
			           ๐ฅ ูุณู ุงููุชุงุฌุฑ ุงูููููุนุฉ
			           ูุธูุฑ ููุท ุฅุฐุง ููุน ุงูุฅุนุฏุงุฏ branches
			           ============================ #}

			{# ุงููุชุงุฌุฑ ุงูููููุนุฉ ูู ุชุนุฏูู ุงูุฅุนุฏุงุฏ #}
{% if row.type == 'branches' %}
<div class="col-12">
    <label class="form-label fw-bold">ุงููุชุงุฌุฑ ุงูููููุนุฉ ูู ุชุนุฏูู ูุฐุง ุงูุฅุนุฏุงุฏ:</label>

    <div class="border rounded p-3" style="background:#fafafa; max-height:240px; overflow-y:auto;">

        {% if branches is not empty %}
            {% for br in branches %}
                <div class="form-check mb-1">
                    <input class="form-check-input"
                           type="checkbox"
                           id="blocked_{{ br.id }}"
                           name="blocked_IDs[]"
                           value="{{ br.id }}"
                           {{ br.id in blocked_ids ? 'checked' }}>
                    <label class="form-check-label" for="blocked_{{ br.id }}">
                        {{ br.name }} (ID: {{ br.id }})
                    </label>
                </div>
            {% endfor %}
        {% else %}
            <div class="text-muted">ูุง ุชูุฌุฏ ูุฑูุน ูุชุงุญุฉ.</div>
        {% endif %}

    </div>

    <div class="form-text text-muted mt-1">
        ุณูุชู ููุน ูุฐู ุงููุฑูุน ูู ุชุนุฏูู ูููุฉ ุงูุฅุนุฏุงุฏ ูู ุตูุญุฉ ุฅุนุฏุงุฏุงุช ุงููุฑูุน.
    </div>
</div>
{% endif %}



		</div>

		<div class="card-footer d-flex justify-content-end gap-2">
			<a href="{{ base }}?type={{ row.type }}" class="btn btn-light">ุฅูุบุงุก</a>
			<button class="btn btn-primary">ุญูุธ</button>
		</div>
	</form>
{% endblock %}

{% block page_scripts %}
	{% if row.val_type == 'select' %}
		 <script>
		(function () {
		
		    function updateRawEdit() {
		        const rows = document.querySelectorAll('#opt_table_edit tbody tr');
		        const arr  = [];
		
		        rows.forEach(function (r) {
		            const v = r.querySelector('.v').value.trim();
		            const l = r.querySelector('.l').value.trim();
		            if (v.length > 0) {
		                arr.push({ value: v, label: l || v });
		            }
		        });
		
		        document.getElementById('options_json_edit').value = JSON.stringify(arr);
		    }
		
		    window.updateRawEdit = updateRawEdit;
		
		    window.addOptRowEdit = function (v = '', l = '') {
		        const tr = document.createElement('tr');
		        tr.innerHTML = `
		            <td><input class="form-control v" value="${v}" oninput="updateRawEdit()"></td>
		            <td><input class="form-control l" value="${l}" oninput="updateRawEdit()"></td>
		            <td class="text-center">
		                <button type="button" class="btn btn-sm btn-danger"
		                    onclick="this.closest('tr').remove(); updateRawEdit();">ร</button>
		            </td>
		        `;
		        document.querySelector('#opt_table_edit tbody').appendChild(tr);
		        updateRawEdit();
		    };
		
		    document.addEventListener('DOMContentLoaded', function () {
		        updateRawEdit();
		    });
		
		})();
		</script>
	{% endif %}
{% endblock %}
