{% extends "layout.twig" %}
{% block title %}منتجات
	{{ market.name }}
{% endblock %}

{% block content %}
	<div class="d-flex justify-content-between align-items-center mb-3">
		<h1 class="h4 mb-0">منتجات:
			{{ market.name }}</h1>
		<div class="d-flex gap-2">
			{% if scoped_market_id is null or scoped_market_id == market.id %}
				<a href="{{ url('/markets/' ~ market.id ~ '/cats/') }}" class="btn btn-outline-secondary">عرض الأقسام</a>

				{% if hasCats %}
					<a href="{{ base }}/create" class="btn btn-primary">إضافة منتج جديد</a>
				{% else %}
					<button class="btn btn-secondary" disabled>إضافة منتج جديد</button>
				{% endif %}

			{% endif %}
		</div>
	</div>

	{# أساس مسار الأصول والرفع #}
	{% set admin_base = (app.base_path ?? '/admincp') %}


	{% if not hasCats %}
		<div class="alert alert-warning mb-3">
			<strong>لا يمكن إضافة منتجات.</strong><br>
			لا يحتوي المتجر على أي أقسام للمنتجات.<br>
			يرجى إضافة قسم أولاً عبر صفحة
			<a href="/admincp/markets/{{ market.id }}/cats/" class="fw-bold text-decoration-underline">الأقسام</a>.
		</div>
	{% endif %}

	{% if (byCat is empty) and (uncategorized is empty) %}
		<div class="alert alert-info">لا توجد منتجات.</div>
	{% else %}
		<div class="table-responsive">
			<table class="table table-hover align-middle">
				<thead class="table-light">
					<tr>
						<th style="width:70px">#</th>
						<th style="width:86px">الغلاف</th>
						<th>الاسم</th>
						<th style="width:120px">السعر</th>
						<th style="width:110px">الحالة</th>
						<th style="width:220px">إجراءات</th>
					</tr>
				</thead>
				<tbody
					class="table-group-divider">

					{# الأقسام (لا نعرض الأقسام الفارغة) #}
					{% for c in cats %}
						{% set list = byCat[c.id] ?? [] %}
						{% if list is not empty %}
							<tr class="table-secondary">
								<td colspan="6" class="fw-bold">القسم:
									{{ c.name }}</td>
							</tr>

							{% for p in list %}
								{% set coverSrc = p.cover
    ? '/uploads/' ~ p.cover
    : admin_base ~ '/assets/img/logo-placeholder.png'
	%}

								<tr>
									<td>{{ p.id }}</td>
									<td>
										<a href="{{ base }}/{{ p.id }}">
											<img src="{{ coverSrc }}" alt="cover" class="img-thumbnail" width="64" height="40" style="object-fit:cover;">
										</a>
									</td>
									<td>
										<a href="{{ base }}/{{ p.id }}" class="text-decoration-none">
											{{ p.name }}
										</a>
									</td>
									<td>{{ p.price }}</td>
									<td>
										<span class="badge {{ p.status == 'active' ? 'bg-success' : 'bg-secondary' }}">
											{{ p.status == 'active' ? 'نشط' : 'غير نشط' }}
										</span>
									</td>
									<td>
										<div class="btn-group btn-group-sm" role="group" aria-label="إجراءات">
											{% if (scoped_market_id is null) or (scoped_market_id == market.id) %}
												<a href="{{ base }}/{{ p.id }}/option-groups" class="btn btn-outline-primary">الخيارات</a>

												<a href="{{ base }}/{{ p.id }}/edit" class="btn btn-outline-secondary">تعديل</a>
												<a href="{{ base }}/{{ p.id }}/delete/confirm" class="btn btn-outline-danger">حذف</a>
											{% endif %}
										</div>
									</td>
								</tr>
							{% endfor %}
						{% endif %}
					{% endfor %}

					{# منتجات بدون قسم (تظهر أخيراً فقط إن كانت موجودة) #}
					{% if uncategorized is not empty %}
						<tr class="table-secondary">
							<td colspan="6" class="fw-bold">بدون قسم</td>
						</tr>
						{% for p in uncategorized %}
							{% set coverSrc = p.cover
              ? '/uploads/' ~ p.cover
              : admin_base ~ '/assets/img/cover-placeholder.jpg' %}
							<tr>
								<td>{{ p.id }}</td>
								<td>
									<a href="{{ base }}/{{ p.id }}">
										<img src="{{ coverSrc }}" alt="cover" class="img-thumbnail" width="64" height="40" style="object-fit:cover;">
									</a>
								</td>
								<td>
									<a href="{{ base }}/{{ p.id }}" class="text-decoration-none">
										{{ p.name }}
									</a>
								</td>
								<td>{{ p.price }}</td>
								<td>
									<span class="badge {{ p.status == 'active' ? 'bg-success' : 'bg-secondary' }}">
										{{ p.status == 'active' ? 'نشط' : 'غير نشط' }}
									</span>
								</td>
								<td>
									<div class="btn-group btn-group-sm" role="group" aria-label="إجراءات">
										{% if (scoped_market_id is null) or (scoped_market_id == market.id) %}
											<a href="{{ base }}/{{ p.id }}/edit" class="btn btn-outline-secondary">تعديل</a>
											<a href="{{ base }}/{{ p.id }}/delete/confirm" class="btn btn-outline-danger">حذف</a>
										{% endif %}
									</div>
								</td>
							</tr>
						{% endfor %}
					{% endif %}

				</tbody>
			</table>
		</div>
	{% endif %}

	<div class="mt-3">
		<a class="btn btn-light" href="{{ admin_base }}/markets">رجوع للمتاجر</a>
	</div>
{% endblock %}
